generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String     @id @default(uuid())
  email      String     @unique
  password   String
  name       String?
  balance    BigInt     @default(0)
  marginUsed BigInt     @default(0)
  createdAt  DateTime   @default(now())
  orders     Order[]
  positions  Position[]
  trades     Trade[]
}

model Underlying {
  id        String           @id @default(uuid())
  symbol    String           @unique
  decimals  Int              @default(2)
  contracts OptionContract[]
   currentPrice BigInt?
  lastUpdated  DateTime?
}

model OptionContract {
  id           String         @id @default(uuid())
  underlyingId String
  optionType   OptionType
  strike       BigInt
  expiry       DateTime
  multiplier   Int
  decimals     Int            @default(2)
  status       ContractStatus @default(ACTIVE)
  underlying   Underlying     @relation(fields: [underlyingId], references: [id])
  orders       Order[]
  positions    Position[]
}

model Order {
  id         String         @id @default(uuid())
  userId     String
  contractId String
  side       Side
  orderType  OrderType
  status     OrderStatus    @default(PENDING)
  price      BigInt?
  qty        Int
  filledQty  Int            @default(0)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  contract   OptionContract @relation(fields: [contractId], references: [id])
  user       User           @relation(fields: [userId], references: [id])
  trades     Trade[]
}

model Position {
  id            String         @id @default(uuid())
  userId        String
  contractId    String
  side          Side
  avgPrice      BigInt
  qty           Int
  realizedPnl   BigInt         @default(0)
  unrealizedPnl BigInt         @default(0)
  createdAt     DateTime       @default(now())
  closedAt      DateTime?
  contract      OptionContract @relation(fields: [contractId], references: [id])
  user          User           @relation(fields: [userId], references: [id])

  @@unique([userId, contractId])
}

model Trade {
  id        String   @id @default(uuid())
  orderId   String
  userId    String
  price     BigInt
  qty       Int
  direction Side
  timestamp DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

enum OptionType {
  CALL
  PUT
}

enum ContractStatus {
  ACTIVE
  EXPIRED
}

enum Side {
  BUY
  SELL
}

enum OrderType {
  MARKET
  LIMIT
}

enum OrderStatus {
  PENDING
  PARTIAL
  FILLED
  CANCELLED
}
